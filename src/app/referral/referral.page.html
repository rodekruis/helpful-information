<ion-header>
  <app-header
    [title]="referralPageData?.referralPageTitle"
    [loading]="loading"
    (backAction)="goBack()"
    [backButtonLabel]="referralPageData?.referralBackButtonLabel"
    [logoUrl]="referralPageData?.referralPageLogo"
    (logoAction)="showRootPage()"
    [logoActionLabel]="referralPageData?.referralMainScreenButtonLabel"
  ></app-header>
</ion-header>

<ion-content
  color="dark"
  class="ion-padding"
>
  <!-- Loading-placeholder -->
  <ng-container *ngIf="isSupportedRegion() && loading">
    <h2>
      <span
        class="loading-text"
        style="width: 33%"
      ></span>
    </h2>
    <div class="ion-margin-vertical ion-padding-bottom">
      <span class="loading-text"></span>
      <span class="loading-text"></span>
      <span
        class="loading-text"
        style="width: 75%"
      ></span>
    </div>
  </ng-container>

  <!-- Region-page = Category-list -->
  <ng-container
    *ngIf="isSupportedRegion() && !loading && !showHighlights && !showSearch && !category && hasDataToShow()"
  >
    <div
      *ngIf="useQandAs"
      class="floating-action-area is_in-page layout--float-end ion-margin-start"
    >
      <a
        *ngIf="useQandAs && qaHighlights.length"
        routerLink="."
        [queryParams]="{ highlights: 'show' }"
        queryParamsHandling="merge"
        routerLinkActive
        #qaHightlightsToggle="routerLinkActive"
        [hidden]="qaHightlightsToggle.isActive"
        [attr.title]="referralPageData?.labelHighlightsItemsCount + ' ' + qaHighlights.length"
        [attr.aria-label]="referralPageData?.labelHighlightsItemsCount + ' ' + qaHighlights.length"
        class="action is_round is_attention text-style--center"
      >
        <strong aria-hidden="true">!</strong>
      </a>
      &nbsp;
      <a
        *ngIf="useQandAs && useQandASearch"
        routerLink="."
        [queryParams]="{ search: 'show' }"
        queryParamsHandling="merge"
        routerLinkActive
        #qaSearchToggle="routerLinkActive"
        [hidden]="qaSearchToggle.isActive"
        [attr.title]="referralPageData?.labelSearchPageTitle"
        [attr.aria-label]="referralPageData?.labelSearchPageTitle"
        class="action is_round is_attention text-style--center"
      >
        <strong
          style="transform: translate(10%, -25%); display: inline-block"
          aria-hidden="true"
          >âŒ•</strong
        >
      </a>
    </div>

    <h2 class="ion-no-margin">{{ referralPageData.referralPageGreeting }}</h2>
    <div
      class="text-style--wrap-newlines ion-margin-vertical ion-padding-bottom"
    >
      <ion-text> {{ referralPageData.referralPageInstructions }} </ion-text>
    </div>
    <ul class="list-flat tile-grid tile-grid_base-3 ion-margin-vertical">
      <li
        *ngFor="let categoryItem of categories"
        class="tile-grid--item"
      >
        <app-link-tile
          [category]="categoryItem"
          [subCategory]="getNextSubCategory(categoryItem)"
        ></app-link-tile>
      </li>
      <li
        *ngIf="(categories.length % 3) <= 1"
        class="tile-grid--item"
        aria-hidden="true"
      >
        <!-- filler-item for empty spot at 2nd-in-a-row -->
      </li>
      <li
        *ngIf="(categories.length % 3) <= 2"
        class="tile-grid--item"
        aria-hidden="true"
      >
        <!-- filler-item for empty spot at 3rd-in-a-row -->
      </li>
    </ul>
    <br /><br /><br />
  </ng-container>

  <!-- Category-page = Sub-Category-list -->
  <ng-container
    *ngIf="isSupportedRegion() && !loading && category && !subCategory"
  >
    <h2 class="ion-no-margin text-style--header text-style--size-1">
      {{ category.categoryName }}
    </h2>
    <p *ngIf="category.categoryDescription">
      {{ category.categoryDescription }}
    </p>

    <ul class="list-flat ion-margin-vertical">
      <li
        *ngFor="let subCategoryItem of subCategories | categoryFilter: category"
        class="ion-margin-bottom"
      >
        <app-sub-category
          [subCategory]="subCategoryItem"
          [category]="category"
        ></app-sub-category>
      </li>
    </ul>
  </ng-container>

  <!-- Sub-Category-page = Offer-list/Q&A-list -->
  <ng-container
    *ngIf="isSupportedRegion() && !loading && category && subCategory && !offer"
  >
    <h2 class="ion-no-margin text-style--header text-style--size-1">
      {{ subCategory.subCategoryName }}
    </h2>
    <p
      *ngIf="subCategory.subCategoryDescription"
      class="text-style--wrap-newlines"
    >
      {{ subCategory.subCategoryDescription }}
    </p>

    <ul
      *ngIf="qaSets && (qaSets | categoryFilter: category | subCategoryFilter: subCategory).length"
      class="list-flat ion-margin-vertical"
    >
      <li
        *ngFor="let _qaSet of qaSets | categoryFilter: category | subCategoryFilter: subCategory"
        class="ion-margin-bottom"
      >
        <app-q-a-set [qaSet]="_qaSet"></app-q-a-set>
      </li>
    </ul>

    <ul class="list-flat ion-margin-vertical">
      <li
        *ngFor="let _offer of offers | categoryFilter: category | subCategoryFilter: subCategory"
        class="ion-margin-bottom"
      >
        <a
          [routerLink]="['.']"
          [queryParams]="{
                categoryID: _offer.categoryID,
                subCategoryID: _offer.subCategoryID,
                offerID: _offer.offerID
              }"
          (click)="clickOffer(_offer)"
          class="action list-item"
        >
          <span class="logo-badge list-item--icon">
            <ion-img
              [title]="_offer.offerIcon"
              [src]="_offer.offerIcon || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'"
              alt=""
              [attr.loading]="'lazy'"
              [attr.decoding]="'async'"
              class="logo-badge--image"
            ></ion-img>
          </span>
          <span
            class="list-item--content text-style--hide-overflow_4 text-style--wrap-newlines"
          >
            <ng-container *ngIf="_offer.offerName">
              <strong>{{ _offer.offerName || '&nbsp;' }}</strong><br />
            </ng-container>
            {{ _offer.offerDescription }}
          </span>
        </a>
      </li>
    </ul>

    <app-last-updated-time
      [label]="referralPageData.labelLastUpdated"
      class="ion-margin-vertical"
    ></app-last-updated-time>
  </ng-container>

  <!-- Q&A-Highlights-page = Q&A-list -->
  <ng-container *ngIf="isSupportedRegion() && !loading && showHighlights">
    <div
      class="floating-action-area is_in-page layout--float-end ion-margin-start"
    >
      <a
        routerLink="."
        [queryParams]="{ highlights: null }"
        queryParamsHandling="merge"
        [attr.title]="referralPageData?.referralBackButtonLabel"
        [attr.aria-label]="referralPageData?.referralBackButtonLabel"
        class="action is_round text-style--center"
      >
        <strong aria-hidden="true">&times;</strong>
      </a>
    </div>

    <h2 class="ion-no-margin text-style--header text-style--size-1">
      {{ referralPageData?.labelHighlightsPageTitle }}
    </h2>

    <p *ngIf="!qaHighlights.length">
      {{ referralPageData?.labelHighlightsItemsZero }}
    </p>

    <p *ngIf="qaHighlights.length">
      {{ referralPageData?.labelHighlightsItemsCount }}
      <strong>{{ qaHighlights.length }}</strong>
    </p>

    <app-q-a-set-list
      [list]="qaHighlights"
      class="ion-margin-vertical"
    ></app-q-a-set-list>
  </ng-container>

  <!-- Search-page = Q&A-list -->
  <ng-container *ngIf="isSupportedRegion() && !loading && showSearch">
    <div
      class="floating-action-area is_in-page layout--float-end ion-margin-start"
    >
      <a
        routerLink="."
        [queryParams]="{ search: null, q: null }"
        queryParamsHandling="merge"
        [attr.title]="referralPageData?.referralBackButtonLabel"
        [attr.aria-label]="referralPageData?.referralBackButtonLabel"
        class="action is_round text-style--center"
      >
        <strong aria-hidden="true">&times;</strong>
      </a>
    </div>

    <h2 class="ion-no-margin text-style--header text-style--size-1">
      {{ referralPageData?.labelSearchPageTitle }}
    </h2>

    <app-search-input
      [(searchQuery)]="searchQuery"
      (doSearch)="performSearch($event)"
      [actionLabel]="referralPageData?.labelSearchAction"
      class="ion-margin-vertical"
    ></app-search-input>

    <p *ngIf="!!searchQuery">
      {{ referralPageData?.labelSearchResultsCount }}
      <strong>{{ searchResults.length }}</strong>
    </p>

    <app-q-a-set-list
      [list]="searchResults"
      [showDateUpdatedOutsideQuestion]="false"
      class="ion-margin-vertical"
    ></app-q-a-set-list>
  </ng-container>

  <!-- Offer-detail page -->
  <ng-container
    *ngIf="isSupportedRegion() && !loading && category && subCategory && offer"
  >
    <app-offer [offer]="offer"></app-offer>

    <app-last-updated-time
      [label]="referralPageData.labelLastUpdated"
      class="ion-margin-vertical"
    ></app-last-updated-time>
  </ng-container>

  <!-- Error/404 page -->
  <ng-container *ngIf="isSupportedRegion() && !loading && !hasDataToShow()">
    <h2>{{ errorHeader }}</h2>
    <p>
      {{ errorMessage }}
      <a
        [href]="errorContactUrl"
        target="_blank"
        rel="noopener noreferrer"
        style="color: red"
        >{{ errorContactUrl }}</a
      >
      <br /><br /><br />
      <a
        href="/"
        onclick="location.reload(true)"
        style="color: gold"
      >
        {{ errorRetry }}
      </a>
    </p>
  </ng-container>

  <!-- Main/Root/Regions-list page -->
  <ng-container *ngIf="!isSupportedRegion()">
    <div
      *ngIf="!category"
      class="ion-margin-bottom ion-padding-bottom"
    >
      <h2 class="text-style--header text-style--size-1">{{ pageHeader }}</h2>
      <p
        class="text-style--wrap-newlines"
        [innerHTML]="pageIntroduction"
      ></p>
    </div>
    <ul class="list-flat tile-grid tile-grid_base-2 ion-margin-vertical">
      <li
        *ngFor="let region of regions"
        class="tile-grid--item"
      >
        <a
          *ngIf="region"
          [routerLink]="['/', region]"
          class="sheet--button action text-style--header text-style--size-1"
        >
          <span>{{ regionsLabels[regions.indexOf(region)] }}</span>
        </a>
      </li>
      <li
        *ngIf="(regions.length % 2) === 1"
        aria-hidden="true"
        class="tile-grid--item"
      >
        <!-- filler-item for empty spot at 2nd-in-a-row -->
      </li>
    </ul>
    <br /><br /><br />
  </ng-container>

  <div
    class="floating-action-area is_bottom-right"
    *ngIf="isSupportedRegion() && hasContactOptions()"
  >
    <span
      class="contact-button"
      *ngIf="referralPageData.referralPhoneNumber"
    >
      <a
        [href]="'tel:' + referralPageData.referralPhoneNumber"
        target="_blank"
        rel="noopener noreferrer"
        (click)="logContactClick('tel')"
        class="contact-button--link"
      >
        <img
          src="assets/icons/contact_phone.png"
          alt="Phone"
          loading="lazy"
          decoding="async"
          class="contact-button--logo"
        />
      </a>
    </span>
    <span
      class="contact-button"
      *ngIf="referralPageData.referralWhatsAppLink"
    >
      <a
        [href]="referralPageData.referralWhatsAppLink"
        target="_blank"
        rel="noopener noreferrer"
        (click)="logContactClick('whatsapp')"
        class="contact-button--link"
      >
        <img
          src="assets/icons/contact_whatsapp.png"
          alt="WhatsApp"
          loading="lazy"
          decoding="async"
          class="contact-button--logo"
        />
      </a>
    </span>
    <span
      class="contact-button"
      *ngIf="referralPageData.referralTelegramLink"
    >
      <a
        [href]="referralPageData.referralTelegramLink"
        target="_blank"
        rel="noopener noreferrer"
        (click)="logContactClick('telegram')"
        class="contact-button--link"
      >
        <img
          src="assets/icons/contact_telegram.png"
          alt="WhatsApp"
          loading="lazy"
          decoding="async"
          class="contact-button--logo"
        />
      </a>
    </span>
  </div>
</ion-content>
